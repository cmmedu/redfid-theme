<%page expression_filter="h" args="online_help_token"/>
<%namespace name='static' file='../static_content.html'/>
<%!
  import six
  from six.moves.urllib.parse import quote
  from django.conf import settings
  from django.urls import reverse
  from django.utils.translation import ugettext as _
  from django.utils.http import urlquote
  from openedx.core.djangoapps.lang_pref.api import header_language_selector_is_enabled, released_languages
  from openedx.core.djangolib.js_utils import js_escaped_string

  from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
  from common.djangoapps.third_party_auth.models import OAuth2ProviderConfig
  lms_base = configuration_helpers.get_value('LMS_BASE', settings.LMS_BASE)
  api_url = configuration_helpers.get_value('redfid_api_url', '')
%>
<header id="header">
  <script>
    var api_url = "${api_url | n, js_escaped_string}";
    window.api_url = api_url;
  </script>
  <script src="${static.url('js/header.js')}"></script>
  % if user.is_authenticated:
  <%
      self.real_user = getattr(user, 'real_user', user)
      username = self.real_user.username
  %>
  <script>
      (function() {
          var username = "${username | n, js_escaped_string}";
          
          function loadUserImages() {
              var userIcons = document.querySelectorAll('.header-usericon');
              
              if (userIcons.length === 0) {
                  // Elements not ready yet, try again after a short delay
                  setTimeout(loadUserImages, 100);
                  return;
              }
          
              // Fetch user image from API
              fetch(api_url + '/user-image/' + username)
              .then(function(response) {
                  if (!response.ok) {
                      throw new Error('Network response was not ok');
                  }
                  return response.json();
              })
              .then(function(data) {
                  var imageUrl = data.url;
                  
                  if (!imageUrl || imageUrl === '' || imageUrl === null) {
                      // If no URL, show the same as when not logged in, but with #bdbdbd background
                      userIcons.forEach(function(icon) {
                          var parent = icon.parentElement;
                          if (parent) {
                              // Replace img with SVG icon
                              icon.style.display = 'none';
                              var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                              svg.setAttribute('class', 'toggle-user-menu');
                              svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                              svg.setAttribute('style', 'padding-left: 1px;');
                              svg.setAttribute('width', '16px');
                              svg.setAttribute('height', '16px');
                              svg.setAttribute('aria-hidden', 'true');
                              svg.setAttribute('focusable', 'false');
                              svg.setAttribute('viewBox', '0 0 512 512');
                              
                              var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                              path.setAttribute('fill', 'white');
                              path.setAttribute('d', 'M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z');
                              svg.appendChild(path);
                              
                              // Update parent background color
                              if (parent.style) {
                                  parent.style.backgroundColor = '#bdbdbd';
                                  parent.style.width = '40px';
                                  parent.style.height = '40px';
                                  parent.style.display = 'flex';
                                  parent.style.alignItems = 'center';
                                  parent.style.justifyContent = 'center';
                                  parent.style.borderRadius = '50%';
                              }
                              
                              parent.appendChild(svg);
                          }
                      });
                  } else {
                      // If URL exists, load the image
                      var fullImageUrl = 'https://static.redfid.cl/api/users' + imageUrl;
                      userIcons.forEach(function(icon) {
                          var parent = icon.parentElement;
                          // Ensure parent has proper styling for image display
                          if (parent && parent.style) {
                              parent.style.width = '40px';
                              parent.style.height = '40px';
                              parent.style.borderRadius = '50%';
                              parent.style.overflow = 'hidden';
                              parent.style.display = 'flex';
                              parent.style.alignItems = 'center';
                              parent.style.justifyContent = 'center';
                              // Remove the default background color
                              parent.style.backgroundColor = '';
                          }
                          icon.src = fullImageUrl;
                          icon.style.display = '';
                          icon.style.width = '40px';
                          icon.style.height = '40px';
                          icon.style.objectFit = 'cover';
                          icon.onerror = function() {
                              // Fallback to default icon if image fails to load
                              this.style.display = 'none';
                              var parent = this.parentElement;
                              if (parent) {
                                  var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                                  svg.setAttribute('class', 'toggle-user-menu');
                                  svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                                  svg.setAttribute('style', 'padding-left: 1px;');
                                  svg.setAttribute('width', '16px');
                                  svg.setAttribute('height', '16px');
                                  svg.setAttribute('aria-hidden', 'true');
                                  svg.setAttribute('focusable', 'false');
                                  svg.setAttribute('viewBox', '0 0 512 512');
                                  
                                  var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                                  path.setAttribute('fill', 'white');
                                  path.setAttribute('d', 'M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z');
                                  svg.appendChild(path);
                                  
                                  if (parent.style) {
                                      parent.style.backgroundColor = '#bdbdbd';
                                      parent.style.width = '40px';
                                      parent.style.height = '40px';
                                      parent.style.display = 'flex';
                                      parent.style.alignItems = 'center';
                                      parent.style.justifyContent = 'center';
                                      parent.style.borderRadius = '50%';
                                  }
                                  
                                  parent.appendChild(svg);
                              }
                          };
                      });
                  }
              })
              .catch(function(error) {
                  console.error('Error fetching user image:', error);
                  // On error, show default icon with #bdbdbd background
                  userIcons.forEach(function(icon) {
                      icon.style.display = 'none';
                      var parent = icon.parentElement;
                      if (parent) {
                          var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                          svg.setAttribute('class', 'toggle-user-menu');
                          svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                          svg.setAttribute('style', 'padding-left: 1px;');
                          svg.setAttribute('width', '16px');
                          svg.setAttribute('height', '16px');
                          svg.setAttribute('aria-hidden', 'true');
                          svg.setAttribute('focusable', 'false');
                          svg.setAttribute('viewBox', '0 0 512 512');
                          
                          var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                          path.setAttribute('fill', 'white');
                          path.setAttribute('d', 'M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z');
                          svg.appendChild(path);
                          
                          if (parent.style) {
                              parent.style.backgroundColor = '#bdbdbd';
                              parent.style.width = '40px';
                              parent.style.height = '40px';
                              parent.style.display = 'flex';
                              parent.style.alignItems = 'center';
                              parent.style.justifyContent = 'center';
                              parent.style.borderRadius = '50%';
                          }
                          
                          parent.appendChild(svg);
                      }
                  });
              });
          }
          
          // Wait for DOM to be ready
          if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', loadUserImages);
          } else {
              // DOM is already ready
              loadUserImages();
          }
      })();
  </script>
  % endif
  <div class="header-bar"></div>
  <div style="box-shadow: 0px 6px 4px -4px #cccccc; position: relative; z-index: 1001; background-color: white;">
      <div class="header-container">
          <div class="header-trigger">&#9776;</div>
          <div class="header-navigation-container">
              <a class="header-navigation-logo" href="https://www.redfid.cl" target="_self">
                  <img class="header-logo" src="${static.url('images/logo.png')}">
              </a>
              <a class="header-navigation-link-active" href="/" target="_self">
                  <p class="header-navigation-link-label" style="margin: revert;">Aprendizaje Profesional</p>
              </a>
              <a class="header-navigation-link" href="https://comunidades.redfid.cl" target="_self">
                  <p class="header-navigation-link-label" style="margin: revert;">Comunidades</p>
              </a>
              <a class="header-navigation-link" href="https://recursos.redfid.cl" target="_self">
                  <p class="header-navigation-link-label" style="margin: revert;">Recursos</p>
              </a>
              <a class="header-navigation-link" href="https://www.redfid.cl/eventos" target="_self">
                <p class="header-navigation-link-label" style="margin: revert;">Noticias y Eventos</p>
            </a>
          </div>
          <div>
              <a class="header-navigation-logo-mobile" href="/" target="_self">
                  <img class="header-logo" src="${static.url('images/logo.png')}">
              </a>
          </div>
          % if user.is_authenticated:
              <div class="toggle-user-menu">
                  <a class="toggle-user-menu header-navigation-logo-mobile" href="#" target="_self" onclick="return false;">
                      <img class="toggle-user-menu header-usericon" src="">
                  </a>
              </div>
          % else:
          <div class="hide-on-desktop toggle-user-menu time-to-get-ill" style="background-color: #40b4ba; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
              <svg class="toggle-user-menu" xmlns="http://www.w3.org/2000/svg" style="padding-left: 1px;" width="16px" height="16px" aria-hidden="true" focusable="false" viewBox="0 0 512 512">
                <path
                  fill="white"
                  d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"
                  />
              </svg>
            </div>
          % endif
          <div class="header-login-container">
              % if user.is_authenticated:
              <div class="toggle-user-menu">
                  <a class="toggle-user-menu time-to-get-ill" href="#" style="background-color: #40b4ba; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;" target="_self" onclick="return false;">
                      <img class="toggle-user-menu header-usericon" src="">
                  </a>
              </div>
              % else:
              <a class="register-button" href="https://www.redfid.cl/formulario-de-registro" target="_self">Regístrate</a>
              <div class="toggle-user-menu time-to-get-ill" style="background-color: #40b4ba; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                  <svg class="toggle-user-menu" xmlns="http://www.w3.org/2000/svg" style="padding-left: 1px;" width="16px" height="16px" aria-hidden="true" focusable="false" viewBox="0 0 512 512">
                    <path
                      fill="white"
                      d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"
                      />
                  </svg>
                </div>
              % endif
          </div>
      </div>
  </div>
  <div class="header-user-container-mobile" style="display: none;">
      % if user.is_authenticated:
      <a class="header-navigation-link-mobile" href="https://www.redfid.cl/perfil" target="_self">
          <i class="fa fa-user" style="color: #40b4ba; margin-right: 8px;"></i>Perfil
      </a>
      <a class="header-navigation-link-mobile" href="/logout" target="_self">
          <i class="fa fa-sign-out" style="color: #40b4ba; margin-right: 8px;"></i>Cerrar sesión
      </a>
      % else:
      <%
          current_path = request.path if request else '/'
          # Check if redfid provider exists and is enabled
          try:
            redfid_provider = OAuth2ProviderConfig.objects.current_set().filter(backend_name='redfid', enabled=True).first()
            redfid_login_enabled = redfid_provider is not None
          except:
            redfid_login_enabled = False
          
          redfid_login_url = f"/auth/login/redfid/?auth_entry=login&next={urlquote(current_path)}" if redfid_login_enabled else "#"
      %>
      <a class="header-navigation-link-mobile" href="https://www.redfid.cl/formulario-de-registro" target="_self">
          Regístrate
      </a>
      <a class="header-navigation-link-mobile" href="${redfid_login_url}" target="_self">
          Iniciar sesión
      </a>
      % endif
  </div>
  <div class="header-navigation-container-mobile" style="display: none;">
      <a class="header-navigation-link-mobile" href="https://www.redfid.cl" target="_self">
          Inicio
      </a>
      <a class="header-navigation-link-mobile-active" href="/" target="_self">
          Aprendizaje Profesional
      </a>
      <a class="header-navigation-link-mobile" href="https://comunidades.redfid.cl" target="_self">
          Comunidades
      </a>
      <a class="header-navigation-link-mobile" href="https://recursos.redfid.cl" target="_self">
          Recursos
      </a>
      <a class="header-navigation-link-mobile" href="https://www.redfid.cl/eventos" target="_self">
        Noticias y Eventos
      </a>
  </div>
</header>
<div class="wrapper-header wrapper" id="view-top">
  <header class="primary" role="banner">
    <div class="wrapper wrapper-l">

      % if context_course:
      <%
            course_key = context_course.id
            url_encoded_course_key = quote(six.text_type(course_key).encode('utf-8'), safe='')
            index_url = reverse('course_handler', kwargs={'course_key_string': six.text_type(course_key)})
            course_team_url = reverse('course_team_handler', kwargs={'course_key_string': six.text_type(course_key)})
            assets_url = reverse('assets_handler', kwargs={'course_key_string': six.text_type(course_key)})
            textbooks_url = reverse('textbooks_list_handler', kwargs={'course_key_string': six.text_type(course_key)})
            videos_url = reverse('videos_handler', kwargs={'course_key_string': six.text_type(course_key)})
            import_url = reverse('import_handler', kwargs={'course_key_string': six.text_type(course_key)})
            course_info_url = reverse('course_info_handler', kwargs={'course_key_string': six.text_type(course_key)})
            export_url = reverse('export_handler', kwargs={'course_key_string': six.text_type(course_key)})
            settings_url = reverse('settings_handler', kwargs={'course_key_string': six.text_type(course_key)})
            grading_url = reverse('grading_handler', kwargs={'course_key_string': six.text_type(course_key)})
            advanced_settings_url = reverse('advanced_settings_handler', kwargs={'course_key_string': six.text_type(course_key)})
            tabs_url = reverse('tabs_handler', kwargs={'course_key_string': six.text_type(course_key)})
            certificates_url = ''
            if settings.FEATURES.get("CERTIFICATES_HTML_VIEW") and context_course.cert_html_view_enabled:
                certificates_url = reverse('certificates_list_handler', kwargs={'course_key_string': six.text_type(course_key)})
            checklists_url = reverse('checklists_handler', kwargs={'course_key_string': six.text_type(course_key)})

      %>
      <h2 class="info-course">
        <span class="sr">${_("Current Course:")}</span>
        <a class="course-link" href="${index_url}">
          <span class="course-org">${context_course.display_org_with_default}</span><span class="course-number">${context_course.display_number_with_default}</span>
          <span class="course-title" title="${context_course.display_name_with_default}">${context_course.display_name_with_default}</span>
        </a>
      </h2>

      <nav class="nav-course nav-dd ui-left" aria-label="${_('Course')}">
        <h2 class="sr">${_("Course Navigation")}</h2>
        <ol>
          <li class="nav-item nav-course-courseware">
            <h3 class="title"><span class="label"><span class="label-prefix sr">${_("Course")} </span>${_("Content")}</span> <span class="icon fa fa-caret-down ui-toggle-dd" aria-hidden="true"></span></h3>

            <div class="wrapper wrapper-nav-sub">
              <div class="nav-sub">
                <ul>
                  <li class="nav-item nav-course-courseware-outline">
                    <a href="${index_url}">${_("Outline")}</a>
                  </li>
                  <li class="nav-item nav-course-courseware-updates">
                    <a href="${course_info_url}">${_("Updates")}</a>
                  </li>
                  <li class="nav-item nav-course-courseware-pages">
                    <a href="${tabs_url}">${_("Pages")}</a>
                  </li>
                  <li class="nav-item nav-course-courseware-uploads">
                    <a href="${assets_url}">${_("Files & Uploads")}</a>
                  </li>
                  <li class="nav-item nav-course-courseware-textbooks">
                    <a href="${textbooks_url}">${_("Textbooks")}</a>
                  </li>
                  % if context_course.video_pipeline_configured:
                  <li class="nav-item nav-course-courseware-videos">
                    <a href="${videos_url}">${_("Video Uploads")}</a>
                  </li>
                  % endif
                </ul>
              </div>
            </div>
          </li>

          <li class="nav-item nav-course-settings">
            <h3 class="title"><span class="label"><span class="label-prefix sr">${_("Course")} </span>${_("Settings")}</span> <span class="icon fa fa-caret-down ui-toggle-dd" aria-hidden="true"></span></h3>

            <div class="wrapper wrapper-nav-sub">
              <div class="nav-sub">
                <ul>
                  <li class="nav-item nav-course-settings-schedule">
                    <a href="${settings_url}">${_("Schedule & Details")}</a>
                  </li>
                  <li class="nav-item nav-course-settings-grading">
                    <a href="${grading_url}">${_("Grading")}</a>
                  </li>
                  <li class="nav-item nav-course-settings-team">
                    <a href="${course_team_url}">${_("Course Team")}</a>
                  </li>
                  <li class="nav-item nav-course-settings-group-configurations">
                    <a href="${reverse('group_configurations_list_handler', kwargs={'course_key_string': six.text_type(course_key)})}">${_("Group Configurations")}</a>
                  </li>
                  % if course_authoring_microfrontend_url:
                  <li class="nav-item nav-course-settings-exams">
                    <a href="${course_authoring_microfrontend_url}/proctored-exam-settings/${url_encoded_course_key}">${_("Proctored Exam Settings")}</a>
                  </li>
                  % endif
                  <li class="nav-item nav-course-settings-advanced">
                    <a href="${advanced_settings_url}">${_("Advanced Settings")}</a>
                  </li>
                  % if certificates_url:
                  <li class="nav-item nav-course-settings-certificates">
                    <a href="${certificates_url}">${_("Certificates")}</a>
                  </li>
                  % endif
                  % if frontend_app_publisher_url:
                  <li class="nav-item nav-course-courseware-videos">
                    <a href="${frontend_app_publisher_url}/course-runs/${url_encoded_course_key}">${_("Publisher")}</a>
                  </li>
                  % endif
                </ul>
              </div>
            </div>
          </li>

          <li class="nav-item nav-course-tools">
            <h3 class="title"><span class="label">${_("Tools")}</span> <span class="icon fa fa-caret-down ui-toggle-dd" aria-hidden="true"></span></h3>
            <div class="wrapper wrapper-nav-sub">
              <div class="nav-sub">
                <ul>
                  <li class="nav-item nav-course-tools-import">
                    <a href="${import_url}">${_("Import")}</a>
                  </li>
                  <li class="nav-item nav-course-tools-export">
                    <a href="${export_url}">${_("Export")}</a>
                  </li>
                  % if settings.FEATURES.get('ENABLE_EXPORT_GIT') and context_course.giturl:
                  <li class="nav-item nav-course-tools-export-git">
                    <a href="${reverse('export_git', kwargs=dict(course_key_string=six.text_type(course_key)))}">${_("Export to Git")}</a>
                  </li>
                  % endif
                  <li class="nav-item nav-course-tools-checklists">
                    <a href="${checklists_url}">${_("Checklists")}</a>
                  </li>
                </ul>
              </div>
            </div>
          </li>
        </ol>
      </nav>
      % elif context_library:
       <%
            library_key = context_library.location.course_key
            index_url = reverse('library_handler', kwargs={'library_key_string': six.text_type(library_key)})
            import_url = reverse('import_handler', kwargs={'course_key_string': six.text_type(library_key)})
            lib_users_url = reverse('manage_library_users', kwargs={'library_key_string': six.text_type(library_key)})
            export_url = reverse('export_handler', kwargs={'course_key_string': six.text_type(library_key)})
      %>
      <h2 class="info-course">
        <span class="sr">${_("Current Library:")}</span>
        <a class="course-link" href="${index_url}">
          <span class="course-org">${context_library.display_org_with_default}</span><span class="course-number">${context_library.display_number_with_default}</span>
          <span class="course-title" title="${context_library.display_name_with_default}">${context_library.display_name_with_default}</span>
        </a>
      </h2>

      <nav class="nav-course nav-dd ui-left" aria-label="${_('Course')}">
        <h2 class="sr">${_("Course Navigation")}</h2>
        <ol>

          <li class="nav-item nav-library-settings">
            <h3 class="title"><span class="label"><span class="label-prefix sr">${_("Library")} </span>${_("Settings")}</span> <span class="icon fa fa-caret-down ui-toggle-dd" aria-hidden="true"></span></h3>
            <div class="wrapper wrapper-nav-sub">
              <div class="nav-sub">
                <ul>
                  <li class="nav-item nav-library-settings-team">
                    <a href="${lib_users_url}">${_("User Access")}</a>
                  </li>
                </ul>
              </div>
            </div>
          </li>
          <li class="nav-item nav-course-tools">
            <h3 class="title"><span class="label">${_("Tools")}</span> <span class="icon fa fa-caret-down ui-toggle-dd" aria-hidden="true"></span></h3>

            <div class="wrapper wrapper-nav-sub">
              <div class="nav-sub">
                <ul>
                  <li class="nav-item nav-course-tools-import">
                    <a href="${import_url}">${_("Import")}</a>
                  </li>
                  <li class="nav-item nav-course-tools-export">
                    <a href="${export_url}">${_("Export")}</a>
                  </li>
                </ul>
              </div>
            </div>
          </li>
        </ol>
      </nav>
      % endif
    </div>
  </header>
</div>