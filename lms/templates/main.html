## coding=utf-8

## This is the main Mako template that all page templates should include.
## Note: there are a handful of pages that use Django Templates and which
## instead include main_django.html. It is important that these two files
## remain in sync, so changes made in one should be applied to the other.

## Pages currently use v1 styling by default. Once the Pattern Library
## rollout has been completed, this default can be switched to v2.
<%page expression_filter="h"/>
<%! main_css = "style-main-v1" %>


<%namespace name='static' file='static_content.html'/>
<% online_help_token = self.online_help_token() if hasattr(self, 'online_help_token') else None %>
<%!
import six
from lms.djangoapps.branding import api as branding_api
from django.urls import reverse
from django.utils.http import urlquote_plus, urlquote
from django.utils.translation import ugettext as _
from django.utils.translation import get_language_bidi
from lms.djangoapps.courseware.access import has_access
from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
from openedx.core.djangolib.js_utils import dump_js_escaped_json, js_escaped_string
from openedx.core.release import RELEASE_LINE
from common.djangoapps.pipeline_mako import render_require_js_path_overrides
from common.djangoapps.third_party_auth.models import OAuth2ProviderConfig

%>
<!DOCTYPE html>
<!--[if lte IE 9]><html class="ie ie9 lte9" lang="${LANGUAGE_CODE}"><![endif]-->
<!--[if !IE]><!--><html lang="${LANGUAGE_CODE}"><!--<![endif]-->
<head dir="${static.dir_rtl()}">

    <!-- Matomo -->
    <script>
      var _paq = window._paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(["setCookieDomain", "*.redfid.cl"]);
      _paq.push(["setDomains", ["*.redfid.cl","*.admin.redfid.cl","*.comunidades.redfid.cl","*.cursos.redfid.cl","*.recursos.redfid.cl"]]);
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//analytics.cmmedu.uchile.cl/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '3']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <noscript><p><img referrerpolicy="no-referrer-when-downgrade" src="//analytics.cmmedu.uchile.cl/matomo.php?idsite=3&amp;rec=1" style="border:0;" alt="" /></p></noscript>
    <!-- End Matomo Code -->

  <%
    is_user_authenticated = user.is_authenticated if user else False
    current_path_for_js = urlquote(request.path if request else '/')
    api_url = configuration_helpers.get_value('redfid_api_url', '')
    cookie_domain = configuration_helpers.get_value('redfid_cookie_domain', '.redfid.cl')
    # Check if redfid provider exists and is enabled
    try:
      redfid_provider = OAuth2ProviderConfig.objects.current_set().filter(backend_name='redfid', enabled=True).first()
      redfid_login_enabled = redfid_provider is not None
    except:
      redfid_login_enabled = False
  %>
  <script>
    var api_url = "${api_url | n, js_escaped_string}";
    window.api_url = api_url;
    var cookie_domain = "${cookie_domain | n, js_escaped_string}";
    window.cookie_domain = cookie_domain;
    var redfidLoginEnabled = ${'true' if redfid_login_enabled else 'false'};
      (function() {
        // Helper function to get cookie by name
        function getCookie(name) {
          if (!document.cookie) {
            return null;
          }
          var nameEQ = name + "=";
          var ca = document.cookie.split(';');
          for(var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) {
              var value = c.substring(nameEQ.length, c.length);
              try {
                return decodeURIComponent(value);
              } catch (e) {
                return value;
              }
            }
          }
          return null;
        }

        // Helper function to delete cookie by name and domain
        function deleteCookie(name, domain) {
          // Delete for the specific domain
          document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=" + domain;
          // Also try without domain (for current domain)
          document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";
        }

        var currentPath = window.location.pathname;
        var isAuthenticated = ${'true' if is_user_authenticated else 'false'};
        var accessTokenCookie = getCookie('access_token');

        // SSO CASE 1: edX logout -> UI logout
        // Intercept logout link clicks and call the logout API endpoint
        // This works even if /logout doesn't render HTML (e.g., redirects immediately)
        (function() {
          function interceptLogoutClick(event) {
            var target = event.target;
            // Find the closest anchor tag if the click was on a child element
            while (target && target.tagName !== 'A') {
              target = target.parentElement;
            }
            
            if (target && target.href && (target.href.indexOf('/logout') !== -1 || target.getAttribute('href') === '/logout')) {
              event.preventDefault();
              event.stopPropagation();
              
              // Prepare headers
              var headers = {
                'Content-Type': 'application/json'
              };
              
              // If we have the access token from cookie, send it as Bearer token
              // (Note: If cookie is HttpOnly, this will be null, but cookie will still be sent)
              var token = getCookie('access_token');
              if (token) {
                headers['Authorization'] = 'Bearer ' + token;
              }
              
              // Call the logout API endpoint
              // The cookie will be sent automatically if accessible
              fetch(api_url + '/logout', {
                method: 'POST',
                credentials: 'include', // Include cookies in the request
                headers: headers
              })
              .then(response => {
                // If API call succeeds, also try to delete the cookie locally as fallback
                deleteCookie('access_token', cookie_domain);
                // Navigate to logout after API call completes
                window.location.href = '/logout';
              })
              .catch(error => {
                console.error('Error calling logout API:', error);
                // On error, still try to delete the cookie locally as fallback
                deleteCookie('access_token', cookie_domain);
                // Navigate to logout even if API call fails
                window.location.href = '/logout';
              });
              
              return false;
            }
          }
          
          // Use event delegation to catch clicks on logout links
          if (document.addEventListener) {
            document.addEventListener('click', interceptLogoutClick, true);
          } else if (document.attachEvent) {
            document.attachEvent('onclick', interceptLogoutClick);
          }
        })();

        // SSO CASE 2: edX login -> UI login
        // Handled by API

        // SSO CASE 3: UI login -> edX login
        // If we are not authenticated, and cookie access_token from .redfid.cl exists, redirect
        // Exclude /logout from this check to avoid redirect loop
        if (!isAuthenticated && (currentPath === '/dashboard' || currentPath === "/")) {
          if (accessTokenCookie && redfidLoginEnabled) {
            var currentPathEncoded = "${current_path_for_js | n, js_escaped_string}";
            var redfidLoginUrl = "/auth/login/redfid/?auth_entry=login&next=" + currentPathEncoded;
            window.location.href = redfidLoginUrl;
          }
        }

        // SSO CASE 4: UI logout -> edX logout
        // TODO
      })();
    </script>

    <meta name="robots" content="noindex" />
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

## Define a couple of helper functions to make life easier when
## embedding theme conditionals into templates. All inheriting
## templates have access to these functions, and we can import these
## into non-inheriting templates via the %namespace tag.

## this needs to be here to prevent the title from mysteriously appearing in the body, in one case
<%def name="pagetitle()" />
  <%block name="title">
      <title>
        RedFID | Aprendizaje Profesional
      </title>
  </%block>

  % if not allow_iframing:
      <script type="text/javascript">
        /* immediately break out of an iframe if coming from the marketing website */
        (function(window) {
          if (window.location !== window.top.location) {
            window.top.location = window.location;
          }
        })(this);
      </script>
  % endif

  <%
    jsi18n_path = "js/i18n/{language}/djangojs.js".format(language=LANGUAGE_CODE)
    ie11_fix_path = "js/ie11_find_array.js"
  %>

  % if getattr(settings, 'CAPTURE_CONSOLE_LOG', False):
    <script type="text/javascript">
      var oldOnError = window.onerror;
      window.localStorage.setItem('console_log_capture', JSON.stringify([]));

      window.onerror = function (message, url, lineno, colno, error) {
        if (oldOnError) {
          oldOnError.apply(this, arguments);
        }

        var messages = JSON.parse(window.localStorage.getItem('console_log_capture'));
        messages.push([message, url, lineno, colno, (error || {}).stack]);
        window.localStorage.setItem('console_log_capture', JSON.stringify(messages));
      }
    </script>
  % endif
  <script type="text/javascript" src="${static.url(jsi18n_path)}"></script>
  <script type="text/javascript" src="${static.url(ie11_fix_path)}"></script>
  <link rel="icon" type="image/x-icon" href="${static.url('images/favicon.ico')}"/>
  <link rel="apple-touch-icon" href="${static.url('images/apple-touch-icon.png')}">
  <link rel="icon" href="${static.url('images/android-chrome-192x192.png')}" sizes="192x192" type="image/png">
  <link rel="icon" href="${static.url('images/android-chrome-512x512.png')}" sizes="512x512" type="image/png">
  <link rel="stylesheet" href="${static.url('redfid-theme/css/redfid-theme/main.css')}">

  <%static:css group='style-vendor'/>
  % if '/' in self.attr.main_css:
    % if get_language_bidi():
      <%
      rtl_css_file = self.attr.main_css.replace('.css', '-rtl.css')
      %>
      <link rel="stylesheet" href="${six.text_type(static.url(rtl_css_file))}" type="text/css" media="all" />
    % else:
      <link rel="stylesheet" href="${static.url(self.attr.main_css)}" type="text/css" media="all" />
    % endif
  % else:
    <%static:css group='${self.attr.main_css}'/>
  % endif

  % if disable_courseware_js:
    <%static:js group='base_vendor'/>
    <%static:js group='base_application'/>
  % else:
    <%static:js group='main_vendor'/>
    <%static:js group='application'/>
  % endif

  <%static:webpack entry="commons"/>

  % if uses_bootstrap:
    ## xss-lint: disable=mako-invalid-js-filter
    <script type="text/javascript" src="${static.url('common/js/vendor/bootstrap.bundle.js')}"></script>
  % endif

  <script>
    window.baseUrl = "${settings.STATIC_URL | n, js_escaped_string}";
    (function (require) {
      require.config({
          baseUrl: window.baseUrl
      });
    }).call(this, require || RequireJS.require);
  </script>
  <script type="text/javascript" src="${static.url("lms/js/require-config.js")}"></script>
  <%block name="js_overrides">
    ${render_require_js_path_overrides(settings.REQUIRE_JS_PATH_OVERRIDES) | n, decode.utf8}
  </%block>

  <%block name="headextra"/>
  <%block name="head_extra"/>

  <%include file="/courseware/experiments.html"/>
  <%include file="/experiments/user_metadata.html"/>
  <%static:optional_include_mako file="head-extra.html" is_theming_enabled="True" />

  <%include file="widgets/optimizely.html" />
  <%include file="widgets/segment-io.html" />

  <meta name="path_prefix" content="${EDX_ROOT_URL}">
  <% google_site_verification_id = configuration_helpers.get_value('GOOGLE_SITE_VERIFICATION_ID', settings.GOOGLE_SITE_VERIFICATION_ID) %>
  % if google_site_verification_id:
    <meta name="google-site-verification" content="${google_site_verification_id}" />
  % endif

  <meta name="openedx-release-line" content="${RELEASE_LINE}" />

<% ga_acct = static.get_value("GOOGLE_ANALYTICS_ACCOUNT", settings.GOOGLE_ANALYTICS_ACCOUNT) %>
% if ga_acct:
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '${ga_acct | n, js_escaped_string}']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
% endif

<% branch_key = static.get_value("BRANCH_IO_KEY", settings.BRANCH_IO_KEY) %>
% if branch_key and not is_from_mobile_app:
    <script type="text/javascript">
        (function(b,r,a,n,c,h,_,s,d,k){if(!b[n]||!b[n]._q){for(;s<_.length;)c(h,_[s++]);d=r.createElement(a);d.async=1;d.src="https://cdn.branch.io/branch-latest.min.js";k=r.getElementsByTagName(a)[0];k.parentNode.insertBefore(d,k);b[n]=h}})(window,document,"script","branch",function(b,r){b[r]=function(){b._q.push([r,arguments])}},{_q:[],_v:1},"addListener applyCode banner closeBanner creditHistory credits data deepview deepviewCta first getCode init link logout redeem referrals removeListener sendSMS setBranchViewData setIdentity track validateCode".split(" "), 0);
        branch.init('${branch_key | n, js_escaped_string}');
    </script>
% endif

</head>

<body class="${static.dir_rtl()} <%block name='bodyclass'/> lang_${LANGUAGE_CODE}">

<%static:optional_include_mako file="body-initial.html" is_theming_enabled="True" />
<div id="page-prompt"></div>
% if not disable_window_wrap:
  <div class="window-wrap" dir="${static.dir_rtl()}">
% endif
    <%block name="skip_links"/>
    <a class="nav-skip sr-only sr-only-focusable" href="#main">${_("Skip to main content")}</a>

    % if not disable_header:
        <%include file="${static.get_template_path('header.html')}" args="online_help_token=online_help_token" />
        <%include file="/preview_menu.html" />
    % endif

    <%include file="/page_banner.html" />

    <div class="marketing-hero"><%block name="marketing_hero"></%block></div>

    <div class="content-wrapper main-container" id="content" dir="${static.dir_rtl()}">
      % if course:
      <div class="course-header">
        <%
        display_name = course.display_name_with_default
        if settings.FEATURES.get('CUSTOM_COURSES_EDX', False):
          ccx = get_current_ccx(course.id)
          if ccx:
            display_name = ccx.display_name
        %>
        <h2 class="course-name">${display_name}</h2>
      </div>
    % endif
      ${self.body()}
      <%block name="bodyextra"/>
    </div>

    % if not disable_footer:
        <%include file="${static.get_template_path('footer.html')}" />
    % endif

% if not disable_window_wrap:
  </div>
% endif

  <%block name="footer_extra"/>
  <%block name="js_extra"/>

  <%include file="widgets/segment-io-footer.html" />
  <script type="text/javascript" src="${static.url('js/vendor/noreferrer.js')}" charset="utf-8"></script>
  <script type="text/javascript" src="${static.url('js/utils/navigation.js')}" charset="utf-8"></script>
  <script type="text/javascript" src="${static.url('js/header/header.js')}"></script>
  <%static:optional_include_mako file="body-extra.html" is_theming_enabled="True" />
  <script type="text/javascript" src="${static.url('js/src/jquery_extend_patch.js')}"></script>
</body>
</html>

<%def name="login_query()">${
  u"?next={next}".format(
    next=urlquote_plus(login_redirect_url if login_redirect_url else request.path)
  ) if (login_redirect_url or (request and not request.path.startswith("/logout"))) else ""
}</%def>
